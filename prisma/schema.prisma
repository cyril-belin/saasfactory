// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// USERS
// ============================================
// Users table extends Supabase Auth users
enum UserRole {
  USER
  SUPER_ADMIN
}

model User {
  id                String              @id @default(uuid())
  email             String              @unique
  role              UserRole            @default(USER)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  // Relations
  workspaceMembers  WorkspaceMember[]
  ownedWorkspaces   Workspace[]         @relation("WorkspaceOwner")
  supportTickets    SupportTicket[]
}

// ============================================
// WORKSPACES (Multi-tenant)
// ============================================
model Workspace {
  id                        String              @id @default(uuid())
  name                      String
  slug                      String              @unique
  ownerId                   String
  
  // Billing - Stripe integration
  stripeCustomerId          String?             @unique
  stripeSubscriptionId      String?             @unique
  stripePriceId             String?
  stripeCurrentPeriodEnd    DateTime?
  subscriptionStatus        SubscriptionStatus  @default(INACTIVE)
  
  createdAt                 DateTime            @default(now())
  updatedAt                 DateTime            @updatedAt
  
  // Relations
  owner                     User                @relation("WorkspaceOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members                   WorkspaceMember[]
  usages                    Usage[]
  
  @@index([ownerId])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
}

// ============================================
// METERING / USAGE
// ============================================
model Usage {
  id            String       @id @default(uuid())
  workspaceId   String
  metricType    MetricType
  currentValue  Int          @default(0)
  maxValue      Int          // Limit snapshot or override
  resetPeriod   ResetPeriod  @default(MONTHLY)
  lastResetAt   DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  
  workspace     Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, metricType])
  @@index([workspaceId])
}

enum MetricType {
  MEMBERS
  API_CALLS
  STORAGE_MB
}

enum ResetPeriod {
  DAILY
  MONTHLY
  NEVER
}

// ============================================
// WORKSPACE MEMBERS
// ============================================
model WorkspaceMember {
  id            String          @id @default(uuid())
  workspaceId   String
  userId        String
  role          WorkspaceRole   @default(MEMBER)
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  workspace     Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([workspaceId, userId])
  @@index([userId])
  @@index([workspaceId])
}

// ============================================
// ANNOUNCEMENTS (Changelog)
// ============================================
model Announcement {
  id            String              @id @default(uuid())
  title         String
  content       String              @db.Text
  type          AnnouncementType    @default(UPDATE)
  isPublic      Boolean             @default(true)
  isPinned      Boolean             @default(false)
  publishedAt   DateTime            @default(now())
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  
  // Relations
  readBy        AnnouncementRead[]
}

// ============================================
// ANNOUNCEMENT READ TRACKING
// ============================================
model AnnouncementRead {
  id              String        @id @default(uuid())
  announcementId  String
  userId          String
  workspaceId     String?
  readAt          DateTime      @default(now())
  
  announcement    Announcement  @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  
  @@unique([announcementId, userId, workspaceId])
  @@index([userId])
  @@index([workspaceId])
}

// ============================================
// FEATURE FLAGS
// ============================================
model FeatureFlag {
  id          String   @id @default(uuid())
  key         String   @unique
  name        String
  description String?
  enabled     Boolean  @default(false)
  value       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([key])
}

// ============================================
// STRIPE EVENTS (for idempotency & logs)
// ============================================
enum StripeEventStatus {
  PENDING
  PROCESSING
  SUCCESS
  FAILED
}

model StripeEvent {
  id          String            @id // Stripe event ID
  type        String
  status      StripeEventStatus @default(PENDING)
  payload     Json?
  error       Json?
  retryCount  Int               @default(0)
  lastAttempt DateTime?         
  processed   Boolean           @default(false)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  
  @@index([type])
  @@index([status])
  @@index([processed])
}

// ============================================
// ENUMS
// ============================================
enum SubscriptionStatus {
  ACTIVE
  TRIALING
  PAST_DUE
  CANCELED
  UNPAID
  INACTIVE
}

enum WorkspaceRole {
  OWNER
  MEMBER
}

enum AnnouncementType {
  FEATURE
  UPDATE
  FIX
  ANNOUNCEMENT
}

// ============================================
// LEGAL PAGES (CMS)
// ============================================
model LegalPage {
  id          String   @id @default(uuid())
  slug        String   @unique // terms, privacy, cookies
  title       String
  content     String   @db.Text
  isPublished Boolean  @default(true)
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())
  
  @@index([slug])
}

// ============================================
// SUBSCRIPTIONS (SaaS Factory)
// ============================================
model SubscriptionPlan {
  id          String   @id @default(uuid())
  name        String
  description String?
  priceId     String   @unique // Stripe Price ID (e.g. price_123)
  amount      Float    // Amount in cents (e.g. 2900)
  currency    String   @default("eur")
  interval    String   @default("month") // month, year, one_time
  features    String[] // List of features
  isActive    Boolean  @default(true)
  popular     Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
}

// ============================================
// SUPPORT TICKETS
// ============================================
model SupportTicket {
  id        String         @id @default(uuid())
  subject   String
  message   String         @db.Text
  status    TicketStatus   @default(OPEN)
  priority  TicketPriority @default(MEDIUM)
  userId    String
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ============================================
// SYSTEM SETTINGS
// ============================================
model SystemSetting {
  key         String   @id
  value       String   @db.Text
  description String?
  category    String   @default("general") // legal, general, ...
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}
